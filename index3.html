<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Timestamp-offset field | Sample | ArcGIS Maps SDK for JavaScript 4.28</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #rightPanel {
        max-height: 98%;
      }

      
      calcite-shell{
            position: relative;
            height: 100vh;
          }

      calcite-shell-panel {
        --calcite-shell-panel-min-width: 420px;
        --calcite-shell-panel-width: 420px;
        --calcite-shell-panel-max-width: 80%;
      }

      calcite-chip[selected] {
        --calcite-ui-border-1: var(--calcite-ui-brand);
      }

      .canvas {
        margin: 0 auto 1rem
      }

      calcite-chip-group {
        margin: 1rem auto .5rem;
      }
  </style>
   <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      "esri/WebMap",
    ], (
      Map,
      MapView,
      FeatureLayer,
      Legend,
      Expand,
      WebMap
    ) => (async () => {
      let webmapId  = "f4f6642aa5514d83aae6de0ebb65057e";
      if (window.location.href.indexOf("?id=") > 0) {
        webmapId = window.location.href.split("?id=")[1];
      }
      const map = new WebMap({
        portalItem: {
          id: webmapId
        }
      });
      

      const view = new MapView({
        map: map,
        container: "viewDiv",
        popupEnabled: false,
      });

      // add fatal accidents of 2021 across USA
      await map.when();
      const layer = map.layers.getItemAt(7);
      console.log(layer);
      await layer.load();
      let layerView = await view.whenLayerView(layer);

      // prepare data for total accidents by time of day chart

      // // Accidents by time of day chart
      // // run stats query to return total number of accidents by time of day
      // // stats results will be grouped by the time of day

      // // create a bar chart showing total number of accidents by time of day



      let charts = [],SDStatusData = [], SDStatusLabels = [];
      // Accidents by time of day chart
      // run stats query to return total number of accidents by time of day
      // stats results will be grouped by the time of day
      const SDStatusResult = await runQuery("1=1", "sd_status");
      for (let feature of SDStatusResult.features) {
        SDStatusData.push(feature.attributes["count"]);
        console.log(feature.attributes);
        SDStatusLabels.push(feature.attributes["sd_status"]);
      }

      // create a bar chart showing total number of accidents by time of day
      updateChart("chart-SDStatus", SDStatusData, SDStatusLabels, false, 50);

      // this function is called 3 times when the app loads and generates
      // count stats for accidents 1. by time of day 2. by day of week and 3. by month
      async function runQuery(where, groupStats) {
        // create a query object that honors the layer settings
        let query = layer.createQuery();
        query.where = where;
        query.outStatistics = [
          {
            statisticType: "count",
            onStatisticField: "*",
            outStatisticFieldName: "count"
          }
        ];
        query.groupByFieldsForStatistics = [groupStats];
        query.orderByFields = [groupStats];
        let result = await layer.queryFeatures(query);
        return result;
      }

      // Keeps track of a selected bar on monthly or week day chart
      // We use this info to toggle the clicked bar color
      let previouslySelectedBarIndex = null;

      // this function is called when user hover the mouse over accidents charts.
      // Accidents layer view feature effect will be updated to highlight features
      // that fall within the selected time, week day or month
      async function applyFilterToAccidentsSDStatus(event, chart) {
        const activePoints = chart.getElementsAtEvent(event);
        // user did not click on a bar. stop here.
        if (activePoints.length == 0) {
          return;
        }
        const chartData = activePoints[0]["_chart"].config.data;
        const idx = activePoints[0]["_index"];

        // There is a selected bar already. Clear up the previous selection before applying a new change
        if (previouslySelectedBarIndex >= 0) {
          // change the bar color back to blue
          changeBarColor(chart, previouslySelectedBarIndex, "#007AC2");
          // clear the feature effect and reset the previous index
          if (previouslySelectedBarIndex === idx) {
            previouslySelectedBarIndex = null;
            layerView.featureEffect = undefined;

          if (dayDistributionChart) {
            dayDistributionChart.data.datasets[0].data = [];
            dayDistributionChart.update();
            dayChartBreakDownBlock.heading = "Click on the graph bar to see hourly chart";
          }
            return;
          }
        }

        // feature effect will be applied based on the chart bar user clicked on
        if (activePoints[0]) {
          const label = chartData.labels[idx];

          changeBarColor(chart, idx, "red");
          previouslySelectedBarIndex = idx;
          let where;
          // apply effect to accidents happened during the selected hour

            const queryValue = label;
            where = `sd_status = '${queryValue}'`;
          
          layerView.featureEffect = {
            filter: {
              where
            },
            excludedEffect: "blur(2px) opacity(0.2) grayscale(0.2)"
          };
        }
      }

      async function dayDistributionStats(where, groupStats, label) {
        const result = await runQuery(where, groupStats);
        let chartData = [], chartLabels = [];

        for (let feature of result.features) {
          chartData.push(feature.attributes["count"]);
          chartLabels.push(feature.attributes["EXPR_1"]);
        }

        if (dayChartBreakDownBlock.style.display === "none") {
          dayChartBreakDownBlock.style.display = "block";
        }

        dayChartBreakDownBlock.heading = label;
        dayDistributionChart.data.datasets[0].data = chartData;
        dayDistributionChart.data.labels = chartLabels;

        const backgroundColors = Array(chartData.length).fill("#007AC2");
        dayDistributionChart.data.datasets[0].backgroundColor = backgroundColors;
        dayDistributionChart.update();
      }

      // called from applyFilterToAccidentsSDStatus function to update the clicked bar color
      function changeBarColor(chart, index, color) {
        chart.data.datasets[0].backgroundColor[index] = color;
        chart.update();
      }

      // UI controls visible in the upper right panel
      let activeGraph = "day";


      // this function is called when the app loads. It creates three charts showing
      // total accidents by time of day, by day of the week and months
      function updateChart(canvas, data, labels, remove, max) {
        const canvasElement = document.getElementById(canvas);

        const backgroundColors = Array(data.length).fill("#007AC2");
        // Get the canvas element and render the chart in it
        let chart = new Chart(canvasElement.getContext("2d"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                backgroundColor: backgroundColors,
                data: data
              }
            ]
          },
          options: {
            responsive: false,
            legend: {
              display: false
            },
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                    max: max
                  }
                }
              ]
            },
            tooltips: {
              displayColors: false,
              callbacks: {
                label: (tooltipItem, data) => {
                  const total =
                    data.datasets[tooltipItem.datasetIndex].data[
                      tooltipItem.index
                    ];
                  return (
                    data.labels[tooltipItem.index] +
                    " - Total accidents: " +
                    total
                  );
                }
              }
            }
          }
        });
        if (!remove) {
          charts.push(chart);
          // add mouse-move event listener on the charts so that we can display features
          // corresponding to the selected by on the chart
          canvasElement.addEventListener("click", async () => {
            const data = await applyFilterToAccidentsSDStatus(event, chart);
          });
        }

        return chart;
      }

      // add a legend widget to the view
      const legendExpand = new Expand({
        expandIcon: "legend",
        view: view,
        content: new Legend({
          view,
          layerInfos: [
            {
              layer: layer,
              title: "Fatal accidents by time of day (2021)"
            }
          ]
        })
      });
      view.ui.add(legendExpand, "bottom-left");

      function createSymbol(color) {
        return {
          type: "simple-marker",
          color: color,
          size: "5px",
          outline: null,
          outline: {
            color: "rgba(153, 31, 23, 0.3)",
            width: 0.3
          }
        };
      }
    })());
  </script>
  </head>
  <body>
    <div id="viewDiv"></div>
    <calcite-shell content-behind class="custom-example-theme">
      <calcite-shell-panel id="rightPanel" slot="panel-end" display-mode="float">
        <calcite-panel id="statsPanel" heading="Fatal Accidents in USA - 2021" description="Explore accidents data">
          <calcite-block open id="chart-block" heading="Total accidents by time of day">
            <canvas class="canvas" id="chart-SDStatus" height="200" width="400"></canvas>
          </calcite-block>
          <calcite-notice slot="footer" open width="full" icon>
            <span slot="title">Note</span>
            <span slot="message">Click on the graph bars to highlight the data in the map</span>
          </calcite-notice>
        </calcite-panel>
      </calcite-shell-panel>
  </calcite-shell>
  </body>
</html>